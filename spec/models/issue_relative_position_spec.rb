# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Issue do
  context 'reproducing #239003' do
    let_it_be(:project) { create(:project) }
    let_it_be(:positions) do
      [
        24063, 24064, 24065, 24066, 24067, 24068, 24069, 24077, 24078, 24079,
        24080, 24081, 24082, 24083, 24084, 24085, 24086, 24086, 24087, 24153,
        24219, 24227, 24235, 24248, 24255, 24258, 24261, 24262, 24273, 24275,
        24282, 24321, 24333, 24355, 24357, 24413, 24648, 24725, 24726, 24728,
        24730, 24731, 24732, 24733, 24740, 24741, 24742, 24743, 24744, 24749,
        24751, 24752, 24753, 24754, 24755, 24756, 24757, 24758, 24759, 24760,
        24761, 24762, 24763, 24766, 24769, 24770, 24771, 24772, 24778, 24791,
        24794, 24795, 24796, 24797, 24798, 24799, 24800, 24831, 24832, 24833,
        24845, 24875, 24877, 24890, 24891, 24892, 24897, 24899, 24900, 24901,
        24904, 24905, 24905, 24910, 24924, 24937, 25204, 25205, 25207, 25211,
        25220, 25221, 25223, 25227, 25235, 25252, 25254, 25258, 25266, 25274,
        25282, 25314, 25814, 25905, 25939, 26064, 26298, 26564, 26814, 27064,
        27314, 27346, 27362, 27389, 27521, 27527, 27533, 27627, 27649, 27679,
        27910, 28085, 28092, 28105, 28107, 28109, 28110, 28113, 28118, 28119,
        28126, 28589, 30339, 30464, 30507, 30565, 30569, 30576, 30577, 30581,
        30587, 30588, 31054, 31121, 31128, 31335, 31392, 31691, 31914, 32559,
        32677, 32691, 32698, 32706, 32736, 32973, 34776, 34783, 34807, 34810,
        34813, 34816, 34820, 34820, 34835, 34837, 34838, 34838, 34840, 34841,
        34841, 34842, 34843, 34843, 34848, 34854, 34864, 34875, 34876, 34877,
        34878, 34878, 34879, 34898, 34899, 34975, 34987, 35010, 35033, 35045,
        35051, 35057, 35073, 35088, 35148, 35187, 35898, 37589, 38089, 38214,
        38464, 40589, 41589, 41667, 41682, 41705, 41714, 42964, 43316, 43464,
        43964, 44464, 47701, 48418, 49645, 49964, 53690, 56464, 58464, 58964,
        59154, 59464, 59964, 60464, 60964, 67496, 70466, 70628, 70957, 71039,
        71123, 71124, 71127, 71129, 71137, 71152, 71781, 78951, 85137, 91502,
        103535, 104839, 106502, 106631, 106670, 106833, 109484, 110177, 110188,
        112768, 116329, 118829, 119787, 119809, 119823, 121371, 121586, 123197,
        124329, 124360, 124458, 125905, 127110, 127345, 127345, 134751, 148120,
        157532, 163001, 164703, 164837, 164885, 165676, 166450, 167929, 167950,
        167950, 170551, 172949, 173422, 173422, 179416, 180772, 183810, 184531,
        188603, 189419, 189740, 189990, 191979, 192148, 192161, 192182, 192798,
        194946, 196224, 196461, 196461, 197572, 197837, 198205, 198217, 198229,
        198241, 198860, 198941, 198985, 199102, 199235, 199423, 199487, 200066,
        200474, 200635, 200635, 205798, 205818, 205846, 206082, 206101, 206110,
        206120, 206158, 206158, 206332, 206844, 207279, 207606, 207862, 207980,
        207980, 208362, 208766, 208766, 208798, 209568, 209812, 210826, 210847,
        211066, 211066, 211298, 211324, 211378, 211414, 211581, 211637, 211680,
        212673, 212829, 213360, 213780, 213934, 215867, 217955, 218909, 219813,
        222600, 223530, 223690, 228110, 230320, 230762, 232530, 232780, 233070,
        233603, 233957, 236193, 241030, 242030, 243268, 243535, 245031, 245037,
        245045, 245061, 245092, 245780, 248367, 248501, 250405, 251967, 252467,
        252967, 254967, 266654, 267154, 268154, 274080, 282154, 282654, 283154,
        283654, 290654, 292685, 292904, 293154, 293154, 293279, 293757, 295654,
        296654, 298654, 298904, 300154, 300654, 301154, 301654, 302154, 303154,
        304154, 304654, 305154, 305654, 306654, 307654, 307904, 308029, 308654,
        308654, 309154, 309654, 310154, 310654, 310654, 315404, 320154, 320654,
        321154, 321654, 322154, 322654, 323154, 323154, 323169, 323247, 324654,
        325779, 326154, 326216, 326935, 329904, 330154, 332154, 333404, 333535,
        334154, 335654, 336154, 336154, 336654, 342529, 342529, 346904, 348404,
        349841, 351154, 351654, 352654, 353763, 355404, 356654, 358154, 361019,
        361154, 362938, 362969, 363001, 363064, 363191, 363469, 363571, 363698,
        363952, 363969, 364001, 364290, 364529, 364529, 364654, 364716, 364966,
        365060, 365154, 366654, 367654, 368654, 369154, 369554, 370904, 372654,
        373654, 374154, 375154, 375654, 375779, 377591, 378231, 378872, 379700,
        380122, 380544, 380966, 381154, 381154, 381810, 382732, 383654, 387904,
        388154, 390654, 391154, 391654, 1073768324, 1073768324, 1073768324,
        1073768324, 1073768324, 1073768324, 1073768324, 1073768324, 1073768324,
        1073768324, 1073768324, 1073768324, 1073768324, 1073768324, 1073768324,
        1073768324, 1073768324, 1073768324, 1073768324, 1073768324, 1073768837,
        27000, 211530, 211780, 27000, 28000, 35382, 211030, 253467, 161030,
        161530, 162030, 27000, 111265, nil, nil, nil, nil, nil, nil, nil, nil,
        nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil,
        195530, 196030, 0, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500,
        5000, 5500, 5562, 5625, 5687, 5750, 6000, 6125, 6250, 6500, 7000, 7250,
        7500, 7750, 8000, 8250, 8500, 8750, 9000, 9062, 9125, 9375, 9500, 9750,
        9875, 10000, 10500, 11000, 11500, 12000, 12500, 13000, 13250, 13500,
        13562, 13593, 13625, 13750, 14000, 14500, 15000, 15500, 15750, 16000,
        16500, 16750, 17000, 17500, 18000, 18500, 18562, 18625, 18750, 19000,
        19500, 19750, 20000, 20250, 20500, 21000, 21500, 21750, 22000, 22125,
        22250, 22375, 22687, 23000, 23125, 23187, 23250, 23500, 23750, 23875,
        24000, 24062, 24088, 24090, 24091, 24092, 24096, 24101, 24103, 24104,
        24112, 24121, 24122, 24123, 24123, 24124, 24126, 24136, 24500, 24684,
        24698, 24701, 24702, 24703, 24703, 24705, 24716, 24717, 24718, 24718,
        24719, 24720, 24721, 24722, 24723, 24724, 24727, 24729, 24734, 24735,
        24736, 24737, 24738, 24739, 24745, 24746, 24747, 24748, 24750, 24754,
        24764, 24765, 24794, 24809, 24811, 24816, 24817, 24818, 24820, 24821,
        24822, 24824, 24826, 24829, 24830, 24834, 24836, 24837, 24838, 24841,
        24843, 24844, 24846, 24849, 24850, 24852, 24853, 24855, 24861, 24863,
        24864, 24865, 24867, 24869, 24869, 24874, 24883, 24889, 24900, 24919,
        24920, 24937, 24956, 24960, 24968, 24982, 24982, 24999, 25001, 25004,
        25005, 25006, 25009, 25009, 25010, 25019, 25020, 25021, 25022, 25045,
        25050, 25054, 25055, 25056, 25057, 25058, 25066, 25075, 25082, 25084,
        25087, 25088, 25090, 25092, 25095, 25097, 25097, 25098, 25099, 25100,
        25101, 25102, 25103, 25104, 25105, 25108, 25110, 25113, 25114, 25156,
        25188, 25203, 25512, 25546, 25901, 26024, 26029, 26034, 26067, 26136,
        26283, 26318, 26337, 26356, 26375, 26377, 26391, 26405, 26415, 26421,
        26425, 26427, 26429, 26430, 26437, 26445, 26447, 26447, 26452, 26452,
        26456, 26456, 26462, 26464, 26465, 26465, 26465, 26465, 26465, 26465,
        26465, 26468, 26469, 26473, 26476, 26479, 26479, 26482, 26482, 26482,
        26486, 26488, 26489, 26491, 26493, 26493, 26496, 26496, 26498, 26514,
        26522, 26531, 26565, 26617, 26669, 26698, 26705, 26707, 26708, 26710,
        26736, 26745, 26747, 26753, 26759, 26762, 26763, 26771, 26773, 26775,
        26778, 26780, 26800, 26807, 26810, 26838, 26848, 26856, 26865, 26866,
        26870, 26872, 26875, 26937, 27492, 27869, 27872, 27892, 27906, 28199,
        28500, 28623, 29093, 29247, 29561, 29625, 29687, 29750, 29871, 30000,
        30500, 30510, 30512, 30513, 30559, 30562, 30625, 30750, 30875, 31000,
        32000, 32500, 33000, 33304, 34000, 34500, 34704, 35089, 35098, 35113,
        35132, 35135, 35147, 35375, 35915, 36000, 36394, 36396, 37500, 38000,
        39500, 41790, 43000, 44000, 44015, 44250, 44500, 45000, 45981, 46000,
        46500, 46964, 47000, 47209, 47332, 47393, 47445, 47455, 47500, 47947,
        48000, 49245, 49380, 49385, 49386, 49387, 49388, 49389, 49403, 49404,
        49414, 49419, 49420, 49421, 49422, 49424, 49426, 49435, 49448, 49468,
        49500, 50125, 50750, 52000, 53666, 55963, 56408, 57000, 57500, 58000,
        59000, 59498, 59500, 60500, 61500, 62625, 67461, 67508, 69983, 70566,
        76500, 78000, 78250, 78500, 79000, 79500, 80000, 81500, 82000, 82171,
        83000, 83042, 87437, 93226, 96500, 96812, 97124, 98000, 99563, 103000,
        104000, 105263, 105500, 106500, 106527, 106724, 106854, 108750, 109625,
        109829, 110107, 110151, 110154, 110179, 110187, 110191, 110202, 110203,
        110275, 110275, 110500, 110625, 110630, 110636, 110732, 110771, 110791,
        110811, 110881, 110952, 111452, 115952, 116452, 117343, 117492, 117596,
        117599, 117603, 117718, 117835, 117952, 118550, 120952, 121025, 121029,
        123362, 123452, 124011, 124013, 124014, 124015, 124017, 124020, 124024,
        124028, 124031, 124202, 124452, 124566, 124879, 124998, 125186, 125327,
        125350, 125514, 126363, 126729, 126941, 126965, 126971, 126974, 126989,
        127073, 127094, 127133, 127280, 127329, 127440, 127452, 127848, 133675,
        134924, 135779, 136537, 137230, 137939, 137944, 137972, 138010, 138144,
        138156, 138168, 138192, 138337, 138530, 138794, 138828, 138977, 139032,
        139033, 139034, 139035, 139036, 139037, 139148, 139197, 139286, 139286,
        139789, 140382, 140702, 141971, 143202, 143702, 150089, 150202, 150702,
        150781, 151391, 151702, 151967, 154202, 154327, 154857, 154936, 154995,
        155559, 157158, 158952, 158973, 158984, 159530, 159531, 159739, 159739,
        160030, 160517, 160530, 160688, 160837, 160933, 160981, 161011, 161017,
        161148, 161339, 161775, 161902, 162026, 162528, 162543, 162747, 163129,
        164803, 164803, 164825, 164827, 164851, 164851, 164851, 164854, 164873,
        164877, 166279, 166498, 166898, 167299, 167408, 167491, 168459, 168482,
        168487, 168490, 168491, 168492, 168493, 168494, 168495, 168496, 168497,
        168498, 168499, 168500, 168501, 168502, 168503, 168505, 168508, 168508,
        168509, 168511, 168512, 168514, 168515, 168516, 168517, 168518, 168519,
        168520, 168521, 168522, 168523, 168523, 168524, 168525, 168526, 168527,
        168539, 168546, 168550, 168565, 168566, 168567, 168592, 169030, 169530,
        172247, 173076, 173414, 173739, 174124, 174574, 176530, 177030, 178030,
        178231, 178529, 180250, 181469, 181718, 182470, 182484, 182599, 182663,
        182695, 183241, 184405, 185561, 186159, 186880, 189905, 190405, 190905,
        190998, 191021, 191092, 191162, 191224, 191780, 191925, 192159, 192160,
        192161, 192163, 192173, 192175, 192186, 192186, 192188, 192193, 192248,
        192627, 192682, 192780, 192926, 193073, 193367, 193367, 194448, 194616,
        194616, 194922, 194989, 195756, 195983, 196045, 196728, 196812, 196812,
        197631, 197833, 198030, 198182, 198781, 199580, 200609, 200880, 201180,
        201873, 201994, 203073, 203530, 204397, 205800, 205817, 205818, 205818,
        205836, 205844, 205972, 206299, 206299, 206530, 206971, 207490, 207530,
        208030, 208530, 208682, 208780, 209100, 210030, 210036, 210042, 210258,
        210495, 211347, 211357, 211558, 211572, 211716, 211965, 212044, 212093,
        212123, 212406, 212667, 212667, 212668, 212668, 212668, 212672, 214378,
        214771, 214771, 215349, 215581, 215797, 215814, 216047, 216115, 217163,
        219623, 219641, 221780, 226280, 228780, 229030, 229050, 229780, 232155,
        232412, 232655, 233067, 233067, 233067, 233069, 233976, 234119, 235780,
        238848, 239761, 240675, 243267, 243268, 243721, 243721, 247484, 249030,
        251030, 251182, 254293, 257404, 259154, 260692, 268654, 270154, 277654,
        277872, 278654, 279154, 280154, 280154, 280654, 280654, 281154, 281154,
        281654, 284154, 284596, 284596, 284654, 289654, 290154, 291154, 291919,
        291919, 292154, 292716, 292810, 292904, 298533, 301190, 310800, 312654,
        337404, 339966, 341654, 341888, 344154, 344404, 344904, 345029, 345091,
        345122, 345154, 353981, 354091, 355654, 357654, 364685, 392154,
        1073768324, 1073768324, 1073768324, 1073768324, 1073768324, 1073768324,
        1073768324, 1073768324, 1073768324, 1073768324, 1073768324, 1073768324,
        24767, 106640, 106650, 194030, 194530, 195030, 195030, 196030, 196530,
        197030, 197530, 1073768324, 1073768324, 1073768324, 1073768324, 24000,
        24500, 24718, 25500, 26000, 26250, 26500, 27000, 27500, 28000, 28076,
        28564, 28846, 29128, 29453, 29507, 29749, 29812, 30062, 33062, 33133,
        34062, 55524, 89387, 123251, 189979, 190479, 190979, 191479, 191979,
        26500, 26625, 26875, 26875, 27000, 29000, 29500, 30000, 31000, 31500,
        32000, 32500, 33000, 33500, 34000, 34500, 35000, 35500, 36000, 40500,
        41000, 41500, 42000, 42500, 43500, 49000, 26500, 27000, 27500, 28000,
        28250, 29250, 29750, 219500, 27000, 27500
      ]
    end
    let_it_be(:offset) { Gitlab::Database::MAX_INT_VALUE - positions.compact.max }
    let_it_be(:bad_positions) { positions.map { |pos| pos.nil? ? nil : pos + offset } }

    before_all do
      bad_positions.each do |pos|
        create(:issue, project: project, author: project.creator, relative_position: pos)
      end
    end

    it 'can create issues at the end of the sequence' do
      new_issue = build(:issue, project: project, author: project.creator)
      new_issue.move_to_end
      new_issue.save!

      expect(project.issues.count).to eq(positions.count + 1)
      expect(project.issues.where.not(relative_position: nil).reorder(relative_position: :desc).first).to eq(new_issue)
    end
  end
end
