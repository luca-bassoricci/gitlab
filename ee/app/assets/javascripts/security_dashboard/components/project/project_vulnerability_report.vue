<script>
import Cookies from 'js-cookie';
import { difference } from 'lodash';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import LocalStorageSync from '~/vue_shared/components/local_storage_sync.vue';
import { parseBoolean } from '~/lib/utils/common_utils';
import {
  API_FUZZING_NAME,
  CLUSTER_IMAGE_SCANNING_NAME,
  CONTAINER_SCANNING_NAME,
  COVERAGE_FUZZING_NAME,
  DEPENDENCY_SCANNING_NAME,
  SECRET_DETECTION_NAME,
} from '~/security_configuration/components/constants';
import ReportNotConfiguredProject from '../shared/empty_states/report_not_configured_project.vue';
import VulnerabilityReportTabs from '../shared/vulnerability_report/vulnerability_report_tabs.vue';
import projectVulnerabilitiesQuery from '../../graphql/queries/project_vulnerabilities.query.graphql';
import AutoFixUserCallout from '../shared/auto_fix_user_callout.vue';
import ProjectPipelineStatus from '../shared/project_pipeline_status.vue';
import securityScannersQuery from '../../graphql/queries/project_security_scanners.query.graphql';
import SecurityScannerAlert from './security_scanner_alert.vue';

export default {
  components: {
    ReportNotConfiguredProject,
    LocalStorageSync,
    SecurityScannerAlert,
    AutoFixUserCallout,
    ProjectPipelineStatus,
    VulnerabilityReportTabs,
  },
  mixins: [glFeatureFlagsMixin()],
  inject: ['fullPath', 'pipeline', 'autoFixDocumentation'],
  data() {
    return {
      scannerAlertDismissed: false,
      securityScanners: {},
      shouldShowAutoFixUserCallout:
        this.glFeatures.securityAutoFix && !Cookies.get(this.$options.autoFixUserCalloutCookieName),
    };
  },
  apollo: {
    securityScanners: {
      query: securityScannersQuery,
      variables() {
        return { fullPath: this.fullPath };
      },
      update({ project = {} }) {
        const { available = [], enabled = [], pipelineRun = [] } = project?.securityScanners || {};
        const translateScannerName = (scannerName) =>
          this.$options.i18n[scannerName] || scannerName;

        return {
          available: available.map(translateScannerName),
          enabled: enabled.map(translateScannerName),
          pipelineRun: pipelineRun.map(translateScannerName),
        };
      },
    },
  },
  computed: {
    isReportConfigured() {
      return this.pipeline?.id;
    },
    notEnabledSecurityScanners() {
      const { available = [], enabled = [] } = this.securityScanners;
      return difference(available, enabled);
    },
    noPipelineRunSecurityScanners() {
      const { enabled = [], pipelineRun = [] } = this.securityScanners;
      return difference(enabled, pipelineRun);
    },
    shouldShowScannersAlert() {
      return (
        !this.scannerAlertDismissed &&
        (this.notEnabledSecurityScanners.length > 0 ||
          this.noPipelineRunSecurityScanners.length > 0)
      );
    },
  },
  methods: {
    closeAutoFixUserCallout() {
      Cookies.set(this.$options.autoFixUserCalloutCookieName, 'true');
      this.shouldShowAutoFixUserCallout = false;
    },
    setScannerAlertDismissed(value) {
      this.scannerAlertDismissed = parseBoolean(value);
    },
  },
  projectVulnerabilitiesQuery,
  autoFixUserCalloutCookieName: 'auto_fix_user_callout_dismissed',
  SCANNER_ALERT_DISMISSED_LOCAL_STORAGE_KEY: 'vulnerability_list_scanner_alert_dismissed',
  i18n: {
    API_FUZZING: API_FUZZING_NAME,
    CONTAINER_SCANNING: CONTAINER_SCANNING_NAME,
    CLUSTER_IMAGE_SCANNING: CLUSTER_IMAGE_SCANNING_NAME,
    COVERAGE_FUZZING: COVERAGE_FUZZING_NAME,
    SECRET_DETECTION: SECRET_DETECTION_NAME,
    DEPENDENCY_SCANNING: DEPENDENCY_SCANNING_NAME,
  },
};
</script>

<template>
  <report-not-configured-project v-if="!isReportConfigured" />

  <div v-else>
    <local-storage-sync
      :value="String(scannerAlertDismissed)"
      :storage-key="$options.SCANNER_ALERT_DISMISSED_LOCAL_STORAGE_KEY"
      @input="setScannerAlertDismissed"
    />
    <security-scanner-alert
      v-if="shouldShowScannersAlert"
      :not-enabled-scanners="notEnabledSecurityScanners"
      :no-pipeline-run-scanners="noPipelineRunSecurityScanners"
      @dismiss="setScannerAlertDismissed('true')"
    />

    <auto-fix-user-callout
      v-if="shouldShowAutoFixUserCallout"
      :help-page-path="autoFixDocumentation"
      @close="closeAutoFixUserCallout"
    />

    <vulnerability-report-tabs :query="$options.projectVulnerabilitiesQuery">
      <template #header-development>
        <project-pipeline-status :pipeline="pipeline" />
      </template>
    </vulnerability-report-tabs>
  </div>
</template>
