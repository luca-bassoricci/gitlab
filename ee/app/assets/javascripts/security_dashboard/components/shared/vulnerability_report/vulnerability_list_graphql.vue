<script>
import { GlLoadingIcon, GlIntersectionObserver } from '@gitlab/ui';
import { produce } from 'immer';
import createFlash from '~/flash';
import { s__ } from '~/locale';
import VulnerabilityList from './vulnerability_list.vue';

// Deep searches an object for a key called 'vulnerabilities'. If it's not found, it will traverse
// down the object's first property until either it's found, or there's nothing left to search. Note
// that this will only check the first property of any object, not all of them.
const deepFindVulnerabilities = (data) => {
  let currentData = data;

  while (currentData !== undefined && currentData.vulnerabilities === undefined) {
    [currentData] = Object.values(currentData);
  }

  return currentData?.vulnerabilities;
};

export default {
  components: { GlLoadingIcon, GlIntersectionObserver, VulnerabilityList },
  inject: ['fullPath', 'canViewFalsePositive'],
  props: {
    query: {
      type: Object,
      required: true,
    },
    filters: {
      type: Object,
      required: false,
      default: null,
    },
    fields: {
      type: Array,
      required: true,
    },
    showProjectNamespace: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data() {
    return {
      vulnerabilities: [],
      sort: undefined,
      pageInfo: undefined,
    };
  },
  apollo: {
    vulnerabilities: {
      query() {
        return this.query;
      },
      errorPolicy: 'none',
      variables() {
        return {
          fullPath: this.fullPath,
          sort: this.sort,
          vetEnabled: this.canViewFalsePositive,
          ...this.filters,
        };
      },
      update(data) {
        const vulnerabilities = deepFindVulnerabilities(data);
        this.pageInfo = vulnerabilities.pageInfo;
        return vulnerabilities.nodes;
      },
      error() {
        createFlash({
          message: s__(
            'SecurityReports|Error fetching the vulnerability list. Please check your network connection and try again.',
          ),
        });
      },
      skip() {
        return !this.filters;
      },
    },
  },
  computed: {
    // Used to show the infinite scrolling loading spinner.
    isLoadingVulnerabilities() {
      return this.$apollo.queries.vulnerabilities.loading;
    },
    // Used to show the initial skeleton loader.
    isLoadingInitialVulnerabilities() {
      return this.isLoadingVulnerabilities && this.vulnerabilities.length <= 0;
    },
    hasNextPage() {
      return this.pageInfo?.hasNextPage;
    },
  },
  watch: {
    filters() {
      // Clear out the vulnerabilities so that the skeleton loader is shown.
      this.vulnerabilities = [];
    },
  },
  methods: {
    updateSort(sort) {
      // Clear out the vulnerabilities so that the skeleton loader is shown.
      this.vulnerabilities = [];
      this.sort = sort;
    },
    fetchNextPage() {
      this.$apollo.queries.vulnerabilities.fetchMore({
        variables: { after: this.pageInfo.endCursor },
        updateQuery: (previousResult, { fetchMoreResult }) => {
          return produce(fetchMoreResult, (draftData) => {
            deepFindVulnerabilities(draftData).nodes.unshift(...this.vulnerabilities);
          });
        },
      });
    },
  },
};
</script>

<template>
  <div>
    <vulnerability-list
      :is-loading="isLoadingInitialVulnerabilities"
      :vulnerabilities="vulnerabilities"
      :fields="fields"
      :should-show-project-namespace="showProjectNamespace"
      @sort-changed="updateSort"
    />

    <gl-intersection-observer v-if="hasNextPage" @appear="fetchNextPage">
      <gl-loading-icon v-if="isLoadingVulnerabilities" size="md" />
    </gl-intersection-observer>
  </div>
</template>
