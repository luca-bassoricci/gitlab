<script>
import vulnerabilitiesQuery from 'ee/security_dashboard/graphql/queries/group_vulnerabilities.query.graphql';
import VulnerabilityReportHeader from '../shared/vulnerability_report/vulnerability_report_header.vue';
import ReportNotConfiguredGroup from '../shared/empty_states/report_not_configured_group.vue';
import VulnerabilityCounts from '../shared/vulnerability_report/vulnerability_counts.vue';
import VulnerabilityListGraphql from '../shared/vulnerability_report/vulnerability_list_graphql.vue';
import VulnerabilityFilters from '../shared/vulnerability_report/vulnerability_filters.vue';
import { FIELDS, FILTERS } from '../shared/vulnerability_report/constants';

export default {
  components: {
    VulnerabilityCounts,
    VulnerabilityListGraphql,
    VulnerabilityFilters,
    ReportNotConfiguredGroup,
    VulnerabilityReportHeader,
  },
  inject: ['canAdminVulnerability', 'hasProjects'],
  data() {
    return {
      filters: undefined,
    };
  },
  computed: {
    fields() {
      return [
        // Add the checkbox field if the user can use the bulk select feature.
        ...[this.canAdminVulnerability ? FIELDS.CHECKBOX : []],
        FIELDS.DETECTED,
        FIELDS.STATUS,
        FIELDS.SEVERITY,
        FIELDS.DESCRIPTION,
        FIELDS.IDENTIFIER,
        FIELDS.TOOL,
        FIELDS.ACTIVITY,
      ];
    },
  },
  methods: {
    updateFilters(filters) {
      this.filters = filters;
    },
  },
  filtersToShow: [
    FILTERS.STATUS,
    FILTERS.SEVERITY,
    FILTERS.TOOL_SIMPLE,
    FILTERS.ACTIVITY,
    FILTERS.PROJECT,
  ],
  vulnerabilitiesQuery,
};
</script>

<template>
  <report-not-configured-group v-if="!hasProjects" />

  <div v-else>
    <vulnerability-report-header />

    <vulnerability-counts class="gl-mt-7" :filters="filters" />

    <vulnerability-filters
      :filters="$options.filtersToShow"
      class="security-dashboard-filters gl-mt-7"
      @filters-changed="updateFilters"
    />

    <vulnerability-list-graphql
      class="gl-mt-6"
      :query="$options.vulnerabilitiesQuery"
      :fields="fields"
      :filters="filters"
      show-project-namespace
    />
  </div>
</template>
